\chapter{Systembeschreibung des Quadrocopters}
\label{chap:Systemarchitektur}
Zu Beginn wird in diesem Kapitel die grundlegende Funktionsweise des Quadrocopters erläutert. 
Anschließend wird die bei dieser Arbeit zum Einsatz kommende Hardware und die Verknüpfung der einzelnen Komponenten miteinander dargelegt.  Dabei geht es darum, aufzuzeigen an welchen Stellen Software bereits fest implementiert ist und wo eigene Algorithmen integriert werden können.



\section{Grundlegende Funktionsweise}
\label{sec:grundFkt}
\label{sec:grundlegenefunktionsweiseQuadrocopter }
Ziel dieses Kapitel ist es ein Verständnis dafür zu erhalten, wie über die gezielte Ansteuerungen der vier Rotoren eine Bewegung des Quadrocopters  hervorgerufen werden kann. Dabei wird auf die wirkenden Kräfte und Momente eingegangen. Zum leichteren Verständnis wird in diesem Kapitel darauf verzichtet, in die Physik der Schubentwicklung \cite{JanKal13} sowie der Kinematik des Quadrocopter einzusteigen. 

Der Schub der Rotoren ist Anhand der Drehzahl $n_i$ der Rotorblätter individuell einstellbar. Damit lassen sich die Kräfte $ F_i $, die an den Endpunkte der Quadrocopterarme der Länge $ l $ wirken, vorgeben.
% Somit lässt sich die Kraft $F_i$ jedes Quadrocopterarmes vorgeben. 
Die Gesamtkraft aller Rotoren ergibt den Schubvektor $S^b$.

\begin{figure}
	\centering
	\includegraphics[width = 0.9\textwidth]{images/funktionsweise_quadrocopter}
	\caption[Momente und Kräfte an einem Quadrocopter]{Momente und Kräfte an einem Quadrocopter}
	\label{fig:funktionsprinzip}
\end{figure}

\begin{equation}
S^b = \begin{bmatrix}
S^{b}_x\\
S^{b}_y\\
S^{b}_z\\
\end{bmatrix}
=
\begin{bmatrix}
0\\
0\\
F_1+F_2+F_3+F_4\\
\end{bmatrix}
\label{eq:Schubvektor}
\end{equation}

Damit der Qudrocopter eine Bewegung im Raum vollziehen kann, muss dieser Vektor aus der Vertikalen ausgelenkt werden. Dies wird durch eine Änderung der Lage realisiert. Reduziert man zum Beispiel die Drehzahl $n_1$ und erhöht gleichzeitig die Drehzahl $n_3$ hat das resultierende Kräfteungleichgewicht über die Länge $ l $ der Quadrocopterarme ein positives Moment um die $y^b$-Achse zur Folge. Der Quadrocopter dreht sich um die $y^b$-Achse, der Pitch-Winkel ändert sich. Der Quadrocopter erfährt in der horizontalen Ebene des Raums eine Beschleunigung. Das gleiche Prinzip gilt auch für den Roll-Winkel, sprich Rotation um die $x^b$-Achse. Hier ist allerdings der Drehzahlenunterschied zwischen $n_2$ und $n_4$ verantwortlich für die Rotation.

Eine Änderung der Orientierung um die Hochachse z, sprich Änderung des Yaw-Winkels, lässt sich ebenfalls über Variation der Rotordrehzahlen hervorrufen. Dabei kommt der Effekt zum tragen, dass der Widerstand der umgebende Luft entgegen der Drehrichtung der Motoren eine Kraft auf die Rotorblätter einprägt. Je nach Drehrichtung der Rotoren wirkt damit ein Moment auf den Quadrocopter.
% Somit über die Rotoren Momente auf den Quadrocopter wirken.
Diese Momente, die an den Armen des Quadrocopters angreifen, lassen sich zur Vereinfachung in den Schwerpunkt verschieben. Damit bei gleicher Drehzahl aller Rotorblätter ein Momentengleichgewicht herrscht, drehen sich die Motoren eins und drei gegen, die Motoren zwei und vier mit dem Uhrzeigersinn. Um die gewünschte Rotation zu erzielen, wird die Drehzahl $n_1$ und $n_3$ erhöht und gleichzeitig  $n_2$ und $n_4$  reduziert. Das Ergebnis ist eine Rotation in positive Richtung.

Zusammenfassen lassen sich die für die Rotation um die Quadrocopter-Achsen verantwortlichen Momente $M^{b}_{x,y,z}$ in einem Vektor $M^b$ zusammenfassen.  

\begin{equation}
M^b = \begin{bmatrix}
M^{b}_x\\
M^{b}_y\\
M^{b}_z\\
\end{bmatrix}
=
\begin{bmatrix}
l(F_3-F_1)\\
l(F_2-F_4)\\
M_1-M_2+M_3-M_4\\
\end{bmatrix}
\end{equation}

Aufzuklären ist, warum mit einer Erhöhung der Drehzahl auch immer eine Reduzierung des Gegenparts verknüpft ist. Die Begründung lautet, dass der Schubvektor $S^b$ durch eine Rotation möglichst wenig beeinflusst werden soll.%, um mit der Gesamtschubvorgabe ganz einfach bestimmt zu werden. 


\section{Aufbau der Hardware}
\label{sec:Hardwareaufbau}
Zum Einsatz kommt der AscTec Pelican der Firma \gls{asctec} \cite{hmpgasctec}. Dieser Quadrocopter ist eine spezielle Entwicklung für die Forschung. Seine Turmstruktur ermöglicht eine einfache Integration zusätzlicher Sensoren und Nutzlasten. Durch die Flexibilität im Aufbau ist das Ziel dieses Teilkapitels, einen Überblick zur Position der einzelnen Komponenten zu geben. Begleitend zum Text sind diese in Abbildung \ref{fig:hardwareaufbau} dargestellt.\\

	\begin{figure}
		\centering
		\includegraphics[width = 0.75\textwidth]{images/Hardwareaufbau}
		\caption[Hardwareaufbau des Quadrocopters]{Hardwareaufbau des Quadrocopters}
		\label{fig:hardwareaufbau}
	\end{figure}

Für jeden der vier mit einem Propeller verbundenen Elektromotoren sind separate Motorcontroller zuständig. Diese sorgen dafür, dass sich die von der \gls{fcu} angeforderten Drehzahlen einstellen.

Die \gls{fcu} ist die zentrale Steuer- und Regeleinheit des Quadrocopters. Sie besitzt zwei ARM7 Prozessoren, einen \gls{llp} und einen \gls{hlp}, zudem verschiedene Kommunikationsschnittstellen (vgl. Kapitel \ref{fig:Kommunikationsstruktur}). Zusätzlich besitzt \gls{fcu} eine inertiale Messeinheit (engl. \gls{imu}). Diese Einheit wird zur Bewegungsdetektion sowie zur Bestimmung der Lage und Ausrichtung benötigt. Sie ist nicht zur Positionsbestimmung in einem ortsfesten Koordinatensystem geeignet. Bestandteile der \gls{imu} sind ein 3D-Beschleunigungssensor, drei Drehratensensoren (Gyros), ein Kompass sowie ein Drucksensor zur Ermittlung der Flughöhe anhand des Luftdrucks. Verbaut sind die Sensoren mit Ausnahme des Kompass direkt auf der Platine ( Abbildung \ref{fig:fcuplatien}).

Da der Einsatzbereich im Indoorbereich liegt, ist der Drucksensor zur Höhenbestimmung in geschlossenen Räumen nicht geeignet. Er liefert erst ab einer Höhe von $ 5~m $ zuverlässige Werte. Daher wurde in einer vorangegangen Arbeit von Jan Kallwies \cite{JanKal13} die Hardware um ein Modul zur Messung der Höhe im Indoorbereich erweitert. Auf diesem Modul befinden sich zwei Infrarotsensoren für den Nahbereich. Beide zusammen decken einen Bereich von $ 4~cm $ bis $ 142~cm $ ab. Erweitert wird der Messbereich durch einen Ultraschallsensor für Entfernungen von bis zu $ 5~m $. Aus diesen drei Sensordaten wird über einen Extended-Kalman-Filter die Flughöhe bestimmt. Eine genaue Beschreibung dieses Fusionsfilters kann in der Arbeit von Jan Kallwies \cite{JanKal13} nachgelesen werden. Da in der vorliegenden Arbeit die Navigation in der horizontale Ebene den Schwerpunkt darstellt, wird dieses Modul hier nicht weiter behandelt.

	\begin{figure}
		\centering
		\includegraphics[width = 0.75\textwidth]{images/FCU_Platine}
		\caption[Platine der \gls{fcu}]{Platine der \gls{fcu}}
		\label{fig:fcuplatien}
	\end{figure}
	
Um in der Horizontalen die Navigation zu gewährleisten, muss die Position des Flugkörpers in der xy-Ebene bekannt sein. Da dies, wie schon beschrieben, nicht mit der Inertialsenorik möglich ist, wurde in die Turmstruktur der Laserscanner UTM-30LX der Firma Hokuyo (Datenblatt im Anhang \ref{anh:datasheet}) integriert. Dieser Scanner hat eine maximale Reichweite von $ 30~m $ und ein Abtastbereich von $ 270° $. Die Umlauffrequenz beträgt dabei $ 40~Hz $, d.h. alle $ 25~ms $ steht ein neuer Scan zur Verfügung.    

Damit zur Berechnung der Position sowie der Implementierung weiterer Algorithmen und Funktionen ausreichend Rechenleistung zur Verfügung steht, befindet sich auf dem Quadrocopter ein zusätzlicher Odroid-X Mikrocomputer mit einem Quad Core Prozessor mit $ 1.4~GHz $ und $ 1024~MB $ LP-DDR2 Arbeitsspeicher. Außerdem besitzt diese Entwicklungsplattform sechs USB-Schnittstellen sowie einen $ 10/100~Mbps $ Ethernet-Anschluss.\\


%Nach dem Überblick über die im Quadrocopter verbaute Hardware und deren Komponenten, geht das folgende Kapitel \ref{sec:Kommunikationsarchitekur} auf die Implementierung der Intelligenz über Software ein.

%Nun sollte man einen Überblick über die im Quadrocopter verbauten Komponenten besitzen. Wie die Einheiten untereinander vernetzt sind, darauf wird im folgenden Kapitel \ref{sec:Kommunikationsarchitekur} eingegangen.

     
\section{Softwarearchitektur und Kommunikationsstruktur}
\label{sec:Kommunikationsarchitekur}

Nachdem im vorhergegangenen Kapitel \ref{sec:Hardwareaufbau} die verbaute Hardware vorgestellt wurde, geht es in diesem Abschnitt um die Softwarearchitektur (Abbildung \ref{fig:Kommunikationsstruktur}). Es wird aufgezeigt, welche Software bereits fest implementiert ist und wo adaptive Applikationen integriert werden können. Des Weiteren wird die Kommunikationsstruktur dargelegt, wie und über welche Protokolle die einzelnen Komponenten miteinander kommunizieren. \\
\begin{figure}
	\centering
	\includegraphics[width = \textwidth]{images/Kommunikationsarchitektur}
	\caption[Softwarearchitektur und Kommunikationsstruktur des Quadrocopters]{Softwarearchitektur und Kommunikationsstruktur des Quadrocopters}
	\label{fig:Kommunikationsstruktur}
\end{figure}
Beginnend mit den beiden Prozessoren 
%der \gls{llp} und \gls{hlp} 
der \gls{fcu}, deren Hauptschleifen der Software mit einer Frequenz von 1kHz durchlaufen werden und die 
%mit der \gls{fcu}, deren beiden Prozessoren \gls{llp} und \gls{hlp} mit einer Frequenz von 1kHz getaktet werden und 
über einen \gls{spi} Bussystem verknüpft sind, wird zunächst der \gls{llp} betrachtet. Auf dem Low Level Prozessor befindet sich die Sensordatenfusion der \gls{imu}-Sensorik zur Lagebestimmung des Quadrocopters. Darauf basiert die Lageregelung, die das Flugverhalten stabilisiert. Hierüber werden die geforderten Sollwinkel bzw. die Solllage eingestellt, die dem \gls{llp} über die Fernbedienung oder den \gls{hlp} übergeben werden. Kombiniert mit der Schubvorgabe werden den Motorreglern die jeweiligen Solldrehzahlen der Rotoren über einen \gls{i2c}-Bus übergeben. Diese Algorithmen sind fest eingepflegt und gewährleisten bei Experimentalflügen eine sichere Rückfallebene. Mit dem \gls{llp} stellt \gls{asctec} dem Benutzer eine Art White-Box zur Verfügung, d.h. die Integration ist bekannt, jedoch nicht deren Umsetzung. Überwachen lässt sich der LLP über einen externen \gls{pc}, in Abbildung \ref{fig:Kommunikationsstruktur} als Bodenstation bezeichnet. Zur Kommunikation werden zwei XBee Funkmodule benötigt. Eines ist am \gls{uart} LL-Serial0 Port der \gls{fcu} angeschlossen, das andere am USB Port der Bodenstation. Mit der AutoPilot Software lassen sich unter anderem der Akkustand, die \gls{imu}-Daten sowie die Stellgrößen der Fernsteuerung betrachten. Außerdem ist es möglich, Parameter der Sensorfusion und der Lageregelung auszulesen und zu verändern.


Mit dem \gls{hlp} stellt \gls{asctec} eine Entwicklungsumgebung zur Implementierung eigener Algorithmen auf der \gls{fcu} zur Verfügung. Hier können erweiternde Programmteile integriert werden, die den Lageregler des \gls{llp} ansprechen oder die direkt den Motorcontroller über den \gls{llp} mit Solldrehzahlen speisen.

Die experimentelle Software auf dem \gls{hlp} kann über die Fernbedienung aktiviert und deaktiviert werden. Eine fehlerhafte Programmierung des \gls{hlp} kann kritische Flugmanöver hervorrufen. Damit diese nicht zum Absturz führen, kann über die Fernbedienung die Experimentalsoftware deaktiviert und das Flugsystem über die ausgereifte Lageregelung auf dem \gls{llp} stabilisiert werden (Rückfallebene).

Wie schon in Kapitel \ref{sec:Hardwareaufbau} beschrieben, befindet sich auf dem Quadorcopter zur Erhöhung der Rechenleistung der Odroid-X. Anders als bei den auf der \gls{fcu} befindlichen Prozessoren, besitzt das Odroid-Bord ein Betriebssystem. Es handelt sich dabei um das opensource Betriebssystem Ubuntu 13.04. Dieses wurde ausgewählt, da es die Installation eines weiteren opensource Betriebssystems ermöglicht, dem \gls{ros}, einem Software Framework für Roboteranwendungen (Kapitel \ref{sec:ros}). Zum Einsatz kommt der Odroid-X bei der Implementierung der Positionsbestimmung (Kapitel \ref{chap:2Dpositionsbestimmung}). Verbunden ist es zum einen über einen USB-Port mit dem Laserscanner. Zum anderen mittels eines weiteren USB-Port über einen \gls{ftdi}-Konverter am HL-Serial0 Port des \gls{hlp} angeschlossen.
Von der Bodenstation kann über \gls{wlan} eine \gls{ssh}~-~Verbindung aufgebaut werden, die in Folge die Entwicklungsplattform bedient.

Nun ist bekannt, wie die einzelnen Komponenten untereinander vernetzt sind. Im weiteren Verlauf der Arbeit lässt sich nachvollziehen, an welchen Stellen die Anwendungen implementiert werden und über welche Verbindungen sie miteinander kommunizieren. 

